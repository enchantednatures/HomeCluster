---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flagger
  namespace: flagger-system
spec:
  interval: 15m
  chart:
    spec:
      chart: flagger
      version: "1.42.0"  # datasource=helm depName=flagger
      sourceRef:
        kind: HelmRepository
        name: flagger
        namespace: flux-system
      interval: 15m
  maxHistory: 2
  install:
    createNamespace: false
    remediation:
      retries: 3
    timeout: 5m
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
    timeout: 5m
  uninstall:
    keepHistory: false
  values:
    image:
      repository: ghcr.io/fluxcd/flagger
      # datasource=docker depName=ghcr.io/fluxcd/flagger
      tag: 1.42.0

    # Configure for Istio mesh provider
    meshProvider: istio
    metricsServer: http://prometheus.monitoring.svc.cluster.local:9090

    # Enable service monitoring
    serviceMonitor:
      enabled: true
      namespace: monitoring

    # CRD is managed separately via CRD file
    crd:
      create: false

    # Config tracking enabled
    configTracking:
      enabled: true

    # Security context
    securityContext:
      enabled: true
      context:
        readOnlyRootFilesystem: true
        runAsUser: 10001

    # Resource limits
    resources:
      limits:
        memory: "512Mi"
        cpu: "1000m"
      requests:
        memory: "128Mi"
        cpu: "100m"

    # Pod annotations for monitoring
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8080"
