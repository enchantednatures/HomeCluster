---
# Ceph Dashboard Virtual Service
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rook-dashboard
  namespace: rook-ceph
  labels:
    app.kubernetes.io/name: rook-dashboard
    app.kubernetes.io/component: dashboard
    app.kubernetes.io/part-of: rook-ceph
spec:
  hosts:
    - rook.${SECRET_DOMAIN}
  gateways:
    - istio-ingress/external-gateway
  http:
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: rook-ceph-mgr-dashboard.rook-ceph.svc.cluster.local
            port:
              number: 8443
      timeout: 60s
      retries:
        attempts: 3
        perTryTimeout: 20s
        retryOn: 5xx,reset,connect-failure,refused-stream
      headers:
        request:
          add:
            x-forwarded-proto: https
            x-forwarded-port: "443"
        response:
          add:
            x-content-type-options: nosniff
            x-frame-options: SAMEORIGIN
            x-xss-protection: "1; mode=block"
---
# Ceph Object Store (S3) Virtual Service
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: rook-objectstore
  namespace: rook-ceph
  labels:
    app.kubernetes.io/name: rook-objectstore
    app.kubernetes.io/component: object-storage
    app.kubernetes.io/part-of: rook-ceph
spec:
  hosts:
    - rgw.${SECRET_DOMAIN}
    - s3.${SECRET_DOMAIN}
  gateways:
    - istio-ingress/external-gateway
  http:
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: rook-ceph-rgw-ceph-objectstore.rook-ceph.svc.cluster.local
            port:
              number: 80
      timeout: 300s  # 5 minutes for large object uploads
      retries:
        attempts: 3
        perTryTimeout: 60s
        retryOn: 5xx,reset,connect-failure,refused-stream
      headers:
        request:
          add:
            x-forwarded-proto: https
            x-forwarded-port: "443"
            # Required for S3 API compatibility
            x-real-ip: "%{DOWNSTREAM_REMOTE_ADDRESS}"
        response:
          add:
            x-content-type-options: nosniff
            x-frame-options: DENY
            x-xss-protection: "1; mode=block"
            # CORS headers for S3 API
            access-control-allow-origin: "*"
            access-control-allow-methods: "GET, POST, PUT, DELETE, HEAD"
            access-control-allow-headers: "Content-Type, Authorization, x-amz-date, x-amz-content-sha256"
