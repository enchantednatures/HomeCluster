---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/ceph.rook.io/cephblockpool_v1.json
apiVersion: ceph.rook.io/v1
kind: CephBlockPool
metadata:
  name: ceph-blockpool
  namespace: rook-ceph
  labels:
    app.kubernetes.io/part-of: rook-ceph
spec:
  failureDomain: host
  replicated:
    size: 3
    requireSafeReplicaSize: true
    replicasPerFailureDomain: 1
    subFailureDomain: host
  parameters:
    # Optimized PG count for 3 OSDs: (3 * 100) / 3 = 100, rounded down to nearest power of 2 = 64
    pg_num: "32" # Conservative for initial deployment
    pgp_num: "32"
    min_size: "2" # Allow I/O with 2 replicas
    compression_mode: "none" # Disable compression for performance
    pg_autoscale_mode: "on" # Let Ceph auto-scale PGs
  compressionMode: none # Disable compression for performance
  enableRBDStats: true
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/storage.k8s.io/storageclass_v1.json
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-block
  labels:
    app.kubernetes.io/part-of: rook-ceph
  annotations:
    # Set as default storage class
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: rook-ceph.rbd.csi.ceph.com
parameters:
  clusterID: rook-ceph
  pool: ceph-blockpool
  imageFormat: "2"
  imageFeatures: layering # Simplified feature set for stability
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
  csi.storage.k8s.io/fstype: ext4
  # Performance optimization
  mapOptions: "krbd:rxbounce"
  unmapOptions: "krbd:rxbounce"
allowVolumeExpansion: true
reclaimPolicy: Delete
volumeBindingMode: Immediate
mountOptions:
  - discard # Enable TRIM support
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/storage.k8s.io/storageclass_v1.json
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-bucket
  labels:
    app.kubernetes.io/part-of: rook-ceph
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: rook-ceph.ceph.rook.io/bucket
parameters:
  objectStoreName: ceph-objectstore
  objectStoreNamespace: rook-ceph
  region: us-east-1
reclaimPolicy: Delete
volumeBindingMode: Immediate
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/storage.k8s.io/storageclass_v1.json
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-bucket-retain
  labels:
    app.kubernetes.io/part-of: rook-ceph
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: rook-ceph.ceph.rook.io/bucket
parameters:
  objectStoreName: ceph-objectstore
  objectStoreNamespace: rook-ceph
  region: us-east-1
reclaimPolicy: Retain
volumeBindingMode: Immediate
---
# Retain policy storage class for critical data
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/storage.k8s.io/storageclass_v1.json
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-block-retain
  labels:
    app.kubernetes.io/part-of: rook-ceph
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: rook-ceph.rbd.csi.ceph.com
parameters:
  clusterID: rook-ceph
  pool: ceph-blockpool
  imageFormat: "2"
  imageFeatures: layering
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
  csi.storage.k8s.io/fstype: ext4
  mapOptions: "krbd:rxbounce"
  unmapOptions: "krbd:rxbounce"
allowVolumeExpansion: true
reclaimPolicy: Retain # CRITICAL: Prevents accidental data deletion
volumeBindingMode: Immediate
mountOptions:
  - discard
