---
# Gateway-level authorization for tekton domain
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: tekton-ingress-istio
  namespace: istio-ingress
spec:
  action: ALLOW
  rules:
  - to:
    - operation:
        hosts:
        - tekton.${SECRET_DOMAIN}
        - tekton.${SECRET_DOMAIN}:443
        - tekton.${SECRET_DOMAIN}:80
  selector:
    matchLabels:
      app: istio-ingressgateway
---
# Service-level authorization requiring authentication
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: tekton-auth-required
  namespace: tekton-pipelines
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: dashboard
  action: CUSTOM
  provider:
    name: authentik
  rules:
    - to:
        - operation:
            hosts:
              - tekton.${SECRET_DOMAIN}
              - tekton.${SECRET_DOMAIN}:*
            # Exclude health checks and API endpoints that might need unauthenticated access
            notPaths:
              - /health
              - /healthz
              - /readiness
              - /api/v1/health
