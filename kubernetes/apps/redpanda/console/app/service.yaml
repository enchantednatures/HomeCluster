---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: kafka-bootstrap-service-entry
  namespace: redpanda
spec:
  hosts:
    - snail-kafka-bootstrap.kafka.svc.cluster.local
  ports:
    - number: 9091
      name: kafka-replication
      protocol: TCP
    - number: 9092
      name: kafka-plain
      protocol: TCP
    - number: 9093
      name: kafka-tls
      protocol: TCP
  location: MESH_INTERNAL
  resolution: DNS
---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: kafka-brokers-service-entry
  namespace: redpanda
spec:
  hosts:
    - snail-kafka-brokers.kafka.svc.cluster.local
  ports:
    - number: 9090
      name: kafka-metrics
      protocol: TCP
    - number: 9091
      name: kafka-replication
      protocol: TCP
    - number: 8443
      name: kafka-oauth
      protocol: TCP
    - number: 9092
      name: kafka-plain
      protocol: TCP
    - number: 9093
      name: kafka-tls
      protocol: TCP
  location: MESH_INTERNAL
  resolution: DNS
---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: kafka-individual-brokers-service-entry
  namespace: redpanda
spec:
  hosts:
    - snail-kafka-0.kafka.svc.cluster.local
    - snail-kafka-1.kafka.svc.cluster.local
    - snail-kafka-2.kafka.svc.cluster.local
    - snail-kafka-3.kafka.svc.cluster.local
    - snail-kafka-4.kafka.svc.cluster.local
  ports:
    - number: 9094
      name: kafka-external
      protocol: TCP
  location: MESH_INTERNAL
  resolution: DNS
---
apiVersion: v1
kind: Service
metadata:
  name: &app console
  namespace: redpanda
  labels:
    app.kubernetes.io/name: *app
    app.kubernetes.io/instance: *app
  annotations:
    # external-dns.alpha.kubernetes.io/hostname: redpanda.${SECRET_DOMAIN}
    lbipam.cilium.io/ips: 192.168.1.244
    tailscale.com/hostname: redpanda-console
    tailscale.com/tags: tag:k8s
spec:
  type: LoadBalancer
  loadBalancerClass: tailscale
  ports:
    - name: console
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app.kubernetes.io/instance: console
    app.kubernetes.io/name: console
# ---
# apiVersion: networking.istio.io/v1beta1
# kind: DestinationRule
# metadata:
#   name: kafka-dr
#   namespace: redpanda
# spec:
#   host: snail-kafka-bootstrap.kafka.svc.cluster.local
#   trafficPolicy:
#     tls:
#       mode: ISTIO_MUTUAL
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: kafka-bootstrap-destination-rule
  namespace: redpanda
spec:
  host: snail-kafka-bootstrap.kafka.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: kafka-brokers-destination-rule
  namespace: redpanda
spec:
  host: snail-kafka-brokers.kafka.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: kafka-individual-brokers-destination-rule
  namespace: redpanda
spec:
  host: "*.kafka.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: DISABLE
