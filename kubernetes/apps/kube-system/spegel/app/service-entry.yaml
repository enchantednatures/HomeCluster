---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: docker-hub-registry
  namespace: kube-system
spec:
  hosts:
    - "registry-1.docker.io"
    - "auth.docker.io"
    - "production.cloudflare.docker.com"
  ports:
    - number: 80
      name: http
      protocol: HTTP
    - number: 443
      name: https
      protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
---
# Add a ServiceEntry for ghcr.io and other common registries
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: other-registries
  namespace: kube-system
spec:
  hosts:
    - "ghcr.io"
    - "registry.k8s.io"
    - "quay.io"
    - "gcr.io"
  ports:
    - number: 80
      name: http
      protocol: HTTP
    - number: 443
      name: https
      protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: registry-tls
  namespace: kube-system
spec:
  host: "registry-1.docker.io"
  trafficPolicy:
    tls:
      mode: SIMPLE
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: other-registries-tls
  namespace: kube-system
spec:
  host: "ghcr.io"
  trafficPolicy:
    tls:
      mode: SIMPLE
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-spegel-egress
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: spegel
  action: ALLOW
  rules:
    - to:
        - operation:
            hosts: ["registry-1.docker.io", "auth.docker.io", "production.cloudflare.docker.com",
                   "ghcr.io", "registry.k8s.io", "quay.io", "gcr.io"]
