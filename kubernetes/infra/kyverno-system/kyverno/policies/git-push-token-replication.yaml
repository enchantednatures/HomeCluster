---
# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/kyverno/main/schemas/kyverno/v1/policy.json
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: replicate-git-push-token
  annotations:
    policies.kyverno.io/title: Replicate Git Push Token Secret
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    kyverno.io/kyverno-version: 1.9.0
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kubernetes-version: "1.24"
    policies.kyverno.io/subject: Secret
    policies.kyverno.io/description: >-
      This policy replicates the git-push-token secret from flux-system namespace
      to all newly created namespaces, ensuring consistent access to git operations
      across the cluster.
spec:
  background: false
  rules:
    - name: generate-git-push-token
      match:
        any:
        - resources:
            kinds:
            - Namespace
      exclude:
        any:
        - resources:
            names:
            - kube-system
            - kube-public
            - kube-node-lease
            - kyverno-system
            - flux-system
            - istio-system
            - rook-ceph
            - openebs-system
            - monitoring
            - knative-*
      generate:
        synchronize: true
        apiVersion: v1
        kind: Secret
        name: git-ssh-key
        namespace: "{{request.object.metadata.name}}"
        clone:
          namespace: flux-system
          name: github-deploy-key