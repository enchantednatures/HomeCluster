---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  add-schemas:
    desc: Add YAML schema annotations to Kubernetes manifests
    summary: |
      Add or update yaml-language-server schema annotations to all Kubernetes
      manifests in the repository. This enables IDE validation and autocomplete.
      
      Modes:
        - Default (dry-run): Preview changes without modifying files
        - Execute: Apply changes to files
      
      Usage:
        task scripts:add-schemas                           # Dry-run mode
        task scripts:add-schemas -- --execute              # Apply changes
        task scripts:add-schemas -- --path kubernetes/apps # Specific directory
        task scripts:add-schemas -- --execute --verbose    # Verbose output
        task scripts:add-schemas -- --help                 # Show full help
    cmd: bash {{.SCRIPTS_DIR}}/add-yaml-schemas.sh {{.CLI_ARGS}}
    preconditions:
      - msg: Script not found at {{.SCRIPTS_DIR}}/add-yaml-schemas.sh
        sh: test -f {{.SCRIPTS_DIR}}/add-yaml-schemas.sh

  extract-ips:
    desc: Extract hardcoded IPs to cluster-wide variables
    summary: |
      Find hardcoded IP addresses in Kubernetes manifests and convert them
      to Flux post-build substitution variables in cluster-settings.yaml.
      
      Features:
        - Auto-detects context and generates meaningful variable names
        - Splits IPs with ports into separate IP and PORT variables
        - Reuses existing variables (like KUBE_VIP_ADDR)
        - Excludes LoadBalancer IPs in service annotations
        - Automatically updates cluster-settings.yaml
      
      Usage:
        task scripts:extract-ips                    # Dry-run (preview)
        task scripts:extract-ips -- --execute       # Apply changes
        task scripts:extract-ips -- --verbose       # Show details
    cmd: bash {{.SCRIPTS_DIR}}/extract-ips-to-vars.sh {{.CLI_ARGS}}
    preconditions:
      - msg: Script not found at {{.SCRIPTS_DIR}}/extract-ips-to-vars.sh
        sh: test -f {{.SCRIPTS_DIR}}/extract-ips-to-vars.sh

  validate-schemas:
    desc: Validate YAML files against their schema annotations
    summary: |
      Validates YAML syntax for all files in the repository.
      Checks for files missing schema annotations.
      
      This is a quick syntax check. For full Kubernetes resource validation,
      use: task kubernetes:kubeconform
      
      Usage:
        task scripts:validate-schemas                    # Validate all files
        task scripts:validate-schemas -- --path kubernetes/apps  # Specific directory
        task scripts:validate-schemas -- --verbose       # Show details
    cmd: bash {{.SCRIPTS_DIR}}/validate-yaml-schemas.sh {{.CLI_ARGS}}
    preconditions:
      - msg: Script not found at {{.SCRIPTS_DIR}}/validate-yaml-schemas.sh
        sh: test -f {{.SCRIPTS_DIR}}/validate-yaml-schemas.sh

  standardize-helmreleases:
    desc: Standardize HelmRelease specifications
    summary: |
      Adds missing standard fields to all HelmRelease files:
        - maxHistory: 2
        - uninstall.keepHistory: false
        - install.remediation.strategy: rollback
        - upgrade.remediation.strategy: rollback
      
      Usage:
        task scripts:standardize-helmreleases            # Dry-run (preview)
        task scripts:standardize-helmreleases -- --execute  # Apply changes
        task scripts:standardize-helmreleases -- --verbose  # Show details
    cmd: bash {{.SCRIPTS_DIR}}/standardize-helmreleases.sh {{.CLI_ARGS}}
    preconditions:
      - msg: Script not found at {{.SCRIPTS_DIR}}/standardize-helmreleases.sh
        sh: test -f {{.SCRIPTS_DIR}}/standardize-helmreleases.sh

  standardize-namespaces:
    desc: Standardize namespace labels
    summary: |
      Adds missing standard labels to all Namespace files:
        - kustomize.toolkit.fluxcd.io/prune: disabled
        - istio.io/dataplane-mode: ambient or disabled
        - pod-security.kubernetes.io/enforce: restricted (optional)
      
      Usage:
        task scripts:standardize-namespaces              # Dry-run (preview)
        task scripts:standardize-namespaces -- --execute # Apply changes
        task scripts:standardize-namespaces -- --execute --pod-security  # Include pod security
        task scripts:standardize-namespaces -- --verbose # Show details
    cmd: bash {{.SCRIPTS_DIR}}/standardize-namespace-labels.sh {{.CLI_ARGS}}
    preconditions:
      - msg: Script not found at {{.SCRIPTS_DIR}}/standardize-namespace-labels.sh
        sh: test -f {{.SCRIPTS_DIR}}/standardize-namespace-labels.sh
